<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>領収書作成</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* 共通レイアウト */
    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .input-section {
      flex: 1;
      min-width: 400px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .preview-section {
      flex: 1;
      min-width: 400px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .client-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .client-row input {
      flex: 1;
    }
    .btn-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    /* プレビュー領域は A4 サイズに近い高さに固定（例：297mm） */
    #preview {
      width: 210mm;
      height: 297mm;
      padding: 20mm;
      margin: 0 auto;
      box-sizing: border-box;
      background-color: white;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .nav-buttons {
      margin-top: 10px;
      text-align: center;
    }
    .radio-group {
      display: flex;
      gap: 20px;
      margin-bottom: 5px;
    }
    .radio-label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    .radio-label input {
      width: auto;
    }
    /* 各受領書ブロックの共通スタイル（グリッドセル用） */
    .receipt-block {
      height: 100%;
      box-sizing: border-box;
      padding-top: 40px; /* 各ブロックの上部開始位置を固定 */
      padding-left: 10px;
      padding-right: 10px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    /* 各ブロック内の要素は余白を固定 */
    .receipt-header {
      text-align: center;
    }
    .receipt-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    .receipt-amount {
      text-align: center;
      border-bottom: 2px solid #000;
      padding-bottom: 5px;
      margin-top: 10px;
    }
    .receipt-note {
      text-align: center;
      margin-top: 10px;
    }
    /* 点線による区切り：グリッドレイアウトの場合、各セルの下側に点線を表示 */
    .receipt-block:not(.receipt-placeholder) {
      border-bottom: 1px dotted #000;
    }
    /* プレースホルダーは空のブロック。高さはグリッドで均等に確保 */
    .receipt-placeholder {
      /* 内容なし。背景色で確認したい場合は下記コメントアウトを外す */
      /* background-color: #f0f0f0; */
    }
    @media print {
      .input-section, .btn-group, .nav-buttons {
        display: none;
      }
      .preview-section {
        border: none;
        width: 100%;
        height: 100%;
        padding: 0;
      }
      #preview {
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <h1>領収書作成</h1>
  <div class="container">
    <div class="input-section">
      <!-- 宛先ブロック：宛先ラベル＋一人／複数人のラジオボタン -->
      <div class="form-group">
        <label>宛先:</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="client-mode" value="single" checked> 一人
          </label>
          <label class="radio-label">
            <input type="radio" name="client-mode" value="multiple"> 複数人
          </label>
        </div>
        <!-- 氏名の入力欄 -->
        <div id="clients-container">
          <div class="client-row" data-row="1">
            <input type="text" class="client-name" placeholder="例: 山田 太郎" oninput="handleClientInput(this)">
          </div>
        </div>
      </div>
      <!-- 領収日 -->
      <div class="form-group">
        <label for="date">領収日:</label>
        <input type="date" id="date">
      </div>
      <!-- 単一モード用：金額入力欄 -->
      <div class="form-group" id="receipt-amount-group">
        <label for="receipt-amount">金額：</label>
        <input type="number" id="receipt-amount" placeholder="金額を入力">
      </div>
      <!-- 複数人モード用オプション -->
      <div id="multiple-options" style="display: none;">
        <!-- 金額 -->
        <div class="form-group" id="per-person-amount-group">
          <label for="per-person-amount">金額：</label>
          <input type="number" id="per-person-amount" placeholder="金額を入力">
        </div>
        <!-- 一人当たりの金額のチェックボックス -->
        <div class="form-group" id="per-amount-mode-group">
          <label>一人当たりの金額：</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="per-amount-mode" value="same" checked> 同額
            </label>
            <label class="radio-label">
              <input type="radio" name="per-amount-mode" value="different"> 異なる
            </label>
          </div>
        </div>
        <!-- 一枚あたりの人数 -->
        <div class="form-group" id="persons-per-page-section">
          <label>一枚あたりの人数（最大3）：</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="persons-per-page" value="1" checked> 1人分
            </label>
            <label class="radio-label">
              <input type="radio" name="persons-per-page" value="2"> 2人分
            </label>
            <label class="radio-label">
              <input type="radio" name="persons-per-page" value="3"> 3人分
            </label>
          </div>
        </div>
      </div>
      <!-- 保存ボタン -->
      <div id="save-buttons" class="btn-group">
        <button id="update-btn" onclick="updatePreview()">更新</button>
      </div>
    </div>
    <div class="preview-section">
      <div id="preview">
        <!-- プレビュー表示領域 -->
      </div>
      <div id="nav-buttons" class="nav-buttons"></div>
    </div>
  </div>

  <script>
    var currentClientIndex = 0; // 複数人モードのグループ分け用

    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

      updateModeDisplay();
      updateSaveButtons();

      document.querySelectorAll('input[name="client-mode"]').forEach(radio => {
        radio.addEventListener('change', function () {
          updateModeDisplay();
          updateSaveButtons();
        });
      });

      document.querySelectorAll('input[name="per-amount-mode"]').forEach(radio => {
        radio.addEventListener('change', function () {
          updateClientAmountField();
        });
      });

      updatePreview();
    });

    // モードに応じた表示項目の切り替え
    function updateModeDisplay() {
      const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
      if (clientMode === 'single') {
        document.getElementById('receipt-amount-group').style.display = 'block';
        document.getElementById('multiple-options').style.display = 'none';
      } else {
        document.getElementById('receipt-amount-group').style.display = 'none';
        document.getElementById('multiple-options').style.display = 'block';
      }
    }

    // 複数人モードで「異なる」場合、各クライアント行に金額入力欄を追加
    function updateClientAmountField() {
      const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
      const perAmountMode = (clientMode === 'multiple') ? document.querySelector('input[name="per-amount-mode"]:checked').value : null;
      const clientRows = document.querySelectorAll('.client-row');
      clientRows.forEach(row => {
        const amountInput = row.querySelector('.client-amount');
        if (clientMode === 'multiple' && perAmountMode === 'different') {
          if (!amountInput) {
            const newInput = document.createElement('input');
            newInput.type = 'number';
            newInput.className = 'client-amount';
            newInput.placeholder = '金額';
            newInput.style.marginLeft = '10px';
            row.appendChild(newInput);
          }
        } else {
          if (amountInput) {
            amountInput.remove();
          }
        }
      });
    }

    // 保存ボタンの更新（個別保存ボタンは【一枚あたりの人数】が1の場合のみ表示）
    function updateSaveButtons() {
      const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
      const container = document.getElementById('save-buttons');
      let html = '<button id="update-btn" onclick="updatePreview()">更新</button> ';
      if (clientMode === 'single') {
        html += '<button id="download-single-btn">PDFで保存</button>';
      } else {
        let personsPerPage = parseInt(document.querySelector('input[name="persons-per-page"]:checked').value);
        if (personsPerPage === 1) {
          html += '<button id="download-individual-btn">個別保存</button> ';
        }
        html += '<button id="download-combined-btn">まとめて保存</button>';
      }
      container.innerHTML = html;
      if (clientMode === 'single') {
        document.getElementById('download-single-btn').addEventListener('click', generateSinglePDF);
      } else {
        if (document.getElementById('download-individual-btn')) {
          document.getElementById('download-individual-btn').addEventListener('click', generateMultiplePDF);
        }
        document.getElementById('download-combined-btn').addEventListener('click', generateCombinedPDF);
      }
    }

    function handleClientInput(input) {
      const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
      if (clientMode === 'single') return;
      const row = input.closest('.client-row');
      const rowNumber = parseInt(row.getAttribute('data-row'));
      const clientName = input.value;
      if (clientName.trim().length > 0) {
        const nextRow = document.querySelector(`.client-row[data-row="${rowNumber + 1}"]`);
        if (!nextRow) {
          addNewClientRow(rowNumber + 1);
        }
      }
      cleanupEmptyClientRows();
    }

    function cleanupEmptyClientRows() {
      let rows = Array.from(document.querySelectorAll('.client-row'));
      let emptyRows = rows.filter(row => row.querySelector('.client-name').value.trim() === '');
      if (emptyRows.length > 1) {
        emptyRows.sort((a, b) => parseInt(a.getAttribute('data-row')) - parseInt(b.getAttribute('data-row')));
        for (let i = 0; i < emptyRows.length - 1; i++) {
          emptyRows[i].remove();
        }
        updateClientRowNumbers();
      }
    }

    function addNewClientRow(rowNumber) {
      const container = document.getElementById('clients-container');
      const newRow = document.createElement('div');
      newRow.className = 'client-row';
      newRow.setAttribute('data-row', rowNumber);
      newRow.innerHTML = `<input type="text" class="client-name" placeholder="例: 山田 太郎" oninput="handleClientInput(this)">`;
      const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
      if (clientMode === 'multiple') {
        const perAmountMode = document.querySelector('input[name="per-amount-mode"]:checked').value;
        if (perAmountMode === 'different') {
          const amountInput = document.createElement('input');
          amountInput.type = 'number';
          amountInput.className = 'client-amount';
          amountInput.placeholder = '金額';
          amountInput.style.marginLeft = '10px';
          newRow.appendChild(amountInput);
        }
      }
      container.appendChild(newRow);
    }

    function updateClientRowNumbers() {
      const rows = document.querySelectorAll('.client-row');
      rows.forEach((row, index) => {
        row.setAttribute('data-row', index + 1);
      });
    }

    // プレビュー更新（更新ボタン押下時のみ実行）
    function updatePreview() {
      const dateInput = document.getElementById('date').value || '';
      let formattedDate = '';
      if (dateInput) {
        const date = new Date(dateInput);
        formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
      } else {
        formattedDate = `${new Date().getFullYear()}年${new Date().getMonth()+1}月${new Date().getDate()}日`;
      }
      const clientMode = document.querySelector('input[name="client-mode"]:checked').value;
      if (clientMode === 'single') {
        const client = document.querySelector('.client-row .client-name').value.trim();
        const amountValue = parseFloat(document.getElementById('receipt-amount').value) || 0;
        generateReceiptPreviewSingle(client, formattedDate, amountValue);
        document.getElementById('nav-buttons').innerHTML = '';
      } else {
        const personsPerPage = parseInt(document.querySelector('input[name="persons-per-page"]:checked').value);
        const allClientRows = Array.from(document.querySelectorAll('.client-row'));
        let validClientRows = allClientRows.filter(row => row.querySelector('.client-name').value.trim() !== '');
        if (validClientRows.length === 0 && allClientRows.length > 0) {
          validClientRows = [allClientRows[0]];
        }
        if (validClientRows.length === 0) {
          document.getElementById('preview').innerHTML = '';
          document.getElementById('nav-buttons').innerHTML = '';
          return;
        }
        // グループの開始インデックス算出
        let startIndex = Math.floor(currentClientIndex / personsPerPage) * personsPerPage;
        let pageClients = validClientRows.slice(startIndex, startIndex + personsPerPage);
        generateReceiptPreviewMultiple(pageClients, formattedDate);
        // ページナビゲーション
        let totalPages = Math.ceil(validClientRows.length / personsPerPage);
        let currentPage = Math.floor(currentClientIndex / personsPerPage);
        let navHtml = '';
        if (currentPage > 0) {
          navHtml += '<button onclick="prevPage()">前のページ</button> ';
        } else {
          navHtml += '<button style="opacity: 0.5; pointer-events: none;">前のページ</button> ';
        }
        if (currentPage < totalPages - 1) {
          navHtml += '<button onclick="nextPage()">次のページ</button>';
        } else {
          navHtml += '<button style="opacity: 0.5; pointer-events: none;">次のページ</button>';
        }
        document.getElementById('nav-buttons').innerHTML = navHtml;
      }
      updateSaveButtons();
    }

    function generateReceiptPreviewSingle(client, formattedDate, amountValue) {
      const previewHTML = `
        <div style="display: block;">
          <div class="receipt-block" style="padding-top:40px;">
            <div class="receipt-header" style="text-align: center;"><h1 style="margin: 0;">領収書</h1></div>
            <div class="receipt-info" style="display: flex; justify-content: space-between; align-items: center;">
              <div>${client} 様</div>
              <div>領収日: ${formattedDate}</div>
            </div>
            <div class="receipt-amount" style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 5px;">
              ￥${Number(amountValue).toLocaleString()}
            </div>
            <p class="receipt-note" style="text-align: center;">上記、正に領収いたしました</p>
          </div>
        </div>
      `;
      document.getElementById('preview').innerHTML = previewHTML;
    }

    // 複数人モード用プレビュー生成（グリッドレイアウトで固定行数を確保）
    function generateReceiptPreviewMultiple(pageClients, formattedDate) {
      const personsPerPage = parseInt(document.querySelector('input[name="persons-per-page"]:checked').value);
      let containerStyle = "";
      let receiptBlocks = "";
      if (personsPerPage === 1) {
        containerStyle = "display: block;";
        pageClients.forEach(clientRow => {
          receiptBlocks += generateReceiptContent(clientRow, formattedDate);
        });
      } else if (personsPerPage === 2) {
        containerStyle = "display: grid; grid-template-rows: repeat(2, 1fr); height: 100%;";
        pageClients.forEach(clientRow => {
          receiptBlocks += generateReceiptContent(clientRow, formattedDate);
        });
        let missingCount = 2 - pageClients.length;
        for (let i = 0; i < missingCount; i++) {
          receiptBlocks += `<div class="receipt-block receipt-placeholder"></div>`;
        }
      } else if (personsPerPage === 3) {
        containerStyle = "display: grid; grid-template-rows: repeat(3, 1fr); height: 100%;";
        pageClients.forEach(clientRow => {
          receiptBlocks += `<div class="receipt-block">` + generateReceiptContentInner(clientRow, formattedDate) + `</div>`;
        });
        let missingCount = 3 - pageClients.length;
        for (let i = 0; i < missingCount; i++) {
          receiptBlocks += `<div class="receipt-block receipt-placeholder"></div>`;
        }
      } else {
        containerStyle = "display: block;";
        pageClients.forEach(clientRow => {
          receiptBlocks += generateReceiptContent(clientRow, formattedDate);
        });
      }
      const previewHTML = `<div style="${containerStyle}">${receiptBlocks}</div>`;
      document.getElementById('preview').innerHTML = previewHTML;
    }

    // 受領書ブロック生成（flex/ブロックレイアウト用）※1人分または複数人でgrid以外の場合
    function generateReceiptContent(clientRow, formattedDate) {
      let clientName = clientRow.querySelector('.client-name').value.trim();
      let amountValue = 0;
      const perAmountMode = document.querySelector('input[name="per-amount-mode"]:checked').value;
      if (perAmountMode === 'same') {
        amountValue = parseFloat(document.getElementById('per-person-amount').value) || 0;
      } else {
        const amountInput = clientRow.querySelector('.client-amount');
        amountValue = amountInput ? (parseFloat(amountInput.value) || 0) : 0;
      }
      return `
        <div class="receipt-block">
          <div class="receipt-header"><h1 style="margin: 0;">領収書</h1></div>
          <div class="receipt-info" style="display: flex; justify-content: space-between; align-items: center;">
            <div>${clientName} 様</div>
            <div>領収日: ${formattedDate}</div>
          </div>
          <div class="receipt-amount">
            ￥${Number(amountValue).toLocaleString()}
          </div>
          <p class="receipt-note">上記、正に領収いたしました</p>
        </div>
      `;
    }

    // 受領書ブロック生成（gridレイアウト用・内側コンテンツのみ）
    function generateReceiptContentInner(clientRow, formattedDate) {
      let clientName = clientRow.querySelector('.client-name').value.trim();
      let amountValue = 0;
      const perAmountMode = document.querySelector('input[name="per-amount-mode"]:checked').value;
      if (perAmountMode === 'same') {
        amountValue = parseFloat(document.getElementById('per-person-amount').value) || 0;
      } else {
        const amountInput = clientRow.querySelector('.client-amount');
        amountValue = amountInput ? (parseFloat(amountInput.value) || 0) : 0;
      }
      return `
          <div class="receipt-header" style="text-align: center;"><h1 style="margin: 0;">領収書</h1></div>
          <div class="receipt-info" style="display: flex; justify-content: space-between; align-items: center;">
            <div>${clientName} 様</div>
            <div>領収日: ${formattedDate}</div>
          </div>
          <div class="receipt-amount">
            ￥${Number(amountValue).toLocaleString()}
          </div>
          <p class="receipt-note">上記、正に領収いたしました</p>
      `;
    }

    function nextPage() {
      const personsPerPage = parseInt(document.querySelector('input[name="persons-per-page"]:checked').value);
      const allClientRows = Array.from(document.querySelectorAll('.client-row')).filter(row => row.querySelector('.client-name').value.trim() !== '');
      let totalPages = Math.ceil(allClientRows.length / personsPerPage);
      let currentPage = Math.floor(currentClientIndex / personsPerPage);
      if (currentPage < totalPages - 1) {
        currentClientIndex = (currentPage + 1) * personsPerPage;
        updatePreview();
      }
    }

    function prevPage() {
      const personsPerPage = parseInt(document.querySelector('input[name="persons-per-page"]:checked').value);
      let currentPage = Math.floor(currentClientIndex / personsPerPage);
      if (currentPage > 0) {
        currentClientIndex = (currentPage - 1) * personsPerPage;
        updatePreview();
      }
    }

    // PDF保存処理（各モード）
    function generateSinglePDF() {
      const { jsPDF } = window.jspdf;
      html2canvas(document.getElementById('preview'), {
        scale: 2,
        useCORS: true,
        logging: false
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const canvasRatio = canvas.height / canvas.width;
        const imageWidth = pdfWidth;
        const imageHeight = imageWidth * canvasRatio;
        if (imageHeight > pdfHeight) {
          const scale = pdfHeight / imageHeight;
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth * scale, pdfHeight);
        } else {
          pdf.addImage(imgData, 'PNG', 0, 0, imageWidth, imageHeight);
        }
        const client = document.querySelector('.client-row .client-name').value.trim();
        const fileName = `領収書_${client || 'single'}.pdf`;
        pdf.save(fileName);
      });
    }

    function generateMultiplePDF() {
      const { jsPDF } = window.jspdf;
      const dateInput = document.getElementById('date').value || '';
      let formattedDate = '';
      if (dateInput) {
        const date = new Date(dateInput);
        formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
      }
      const allClientRows = Array.from(document.querySelectorAll('.client-row'));
      const validClientRows = allClientRows.filter(row => row.querySelector('.client-name').value.trim() !== '');
      let index = 0;
      function processClient() {
        if (index >= validClientRows.length) return;
        currentClientIndex = index;
        updatePreview();
        html2canvas(document.getElementById('preview'), {
          scale: 2,
          useCORS: true,
          logging: false
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const canvasRatio = canvas.height / canvas.width;
          const imageWidth = pdfWidth;
          const imageHeight = imageWidth * canvasRatio;
          if (imageHeight > pdfHeight) {
            const scale = pdfHeight / imageHeight;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth * scale, pdfHeight);
          } else {
            pdf.addImage(imgData, 'PNG', 0, 0, imageWidth, imageHeight);
          }
          const client = validClientRows[index].querySelector('.client-name').value.trim();
          const fileName = `領収書_${client || ('client' + (index+1))}.pdf`;
          pdf.save(fileName);
          index++;
          setTimeout(processClient, 500);
        });
      }
      processClient();
    }

    function generateCombinedPDF() {
      const { jsPDF } = window.jspdf;
      const dateInput = document.getElementById('date').value || '';
      let formattedDate = '';
      if (dateInput) {
        const date = new Date(dateInput);
        formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
      }
      const allClientRows = Array.from(document.querySelectorAll('.client-row'));
      const validClientRows = allClientRows.filter(row => row.querySelector('.client-name').value.trim() !== '');
      if (validClientRows.length === 0) {
        alert('宛先が設定されていません。');
        return;
      }
      const personsPerPage = parseInt(document.querySelector('input[name="persons-per-page"]:checked').value);
      const pdf = new jsPDF('p','mm','a4');
      let processIndex = 0;
      function processClientCombined() {
        if (processIndex >= validClientRows.length) {
          let fileName = prompt("保存するファイル名を入力してください（拡張子不要）", "領収書_まとめ");
          if (!fileName || fileName.trim() === "") {
            fileName = "領収書_まとめ";
          }
          fileName = fileName.trim() + ".pdf";
          pdf.save(fileName);
          return;
        }
        let pageClients = validClientRows.slice(processIndex, processIndex + personsPerPage);
        currentClientIndex = processIndex;
        generateReceiptPreviewMultiple(pageClients, formattedDate);
        html2canvas(document.getElementById('preview'), {
          scale: 2,
          useCORS: true,
          logging: false
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const canvasRatio = canvas.height / canvas.width;
          const imageWidth = pdfWidth;
          const imageHeight = imageWidth * canvasRatio;
          if (imageHeight > pdfHeight) {
            const scale = pdfHeight / imageHeight;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth * scale, pdfHeight);
          } else {
            pdf.addImage(imgData, 'PNG', 0, 0, imageWidth, imageHeight);
          }
          processIndex += personsPerPage;
          if (processIndex < validClientRows.length) {
            pdf.addPage();
          }
          setTimeout(processClientCombined, 500);
        });
      }
      processClientCombined();
    }
  </script>
</body>
</html>
